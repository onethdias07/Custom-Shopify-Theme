{% comment %}
Search Results Template
Displays search results for products, collections, pages, and articles
{% endcomment %}

<div class="search-page-container">
  <!-- Search Header -->
  <div class="search-header">
    <div class="search-header-content">
      <h1 class="search-title">
        {% if search.performed %}
          {% if search.results_count == 0 %}
            No results found for "{{ search.terms }}"
          {% else %}
            {{ search.results_count }} 
            {% if search.results_count == 1 %}result{% else %}results{% endif %} 
            for "{{ search.terms }}"
          {% endif %}
        {% else %}
          Search
        {% endif %}
      </h1>
      
      <!-- Search Form -->
      <form action="{{ routes.search_url }}" method="get" class="search-form">
        <div class="search-input-wrapper">
          <input 
            type="search" 
            name="q" 
            value="{{ search.terms | escape }}"
            placeholder="Search products, collections, pages..." 
            class="search-input"
            aria-label="Search"
            autofocus
          >
          <button type="submit" class="search-submit">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="visually-hidden">Search</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  {% if search.performed %}
    {% if search.results_count > 0 %}
      <!-- Search Filters -->
      <div class="search-filters">
        <div class="search-filter-tabs">
          <button class="search-filter-tab active" data-filter="all">
            All Results ({{ search.results_count }})
          </button>
          
          {% assign product_count = 0 %}
          {% assign collection_count = 0 %}
          {% assign page_count = 0 %}
          {% assign article_count = 0 %}
          
          {% for item in search.results %}
            {% case item.object_type %}
              {% when 'product' %}
                {% assign product_count = product_count | plus: 1 %}
              {% when 'collection' %}
                {% assign collection_count = collection_count | plus: 1 %}
              {% when 'page' %}
                {% assign page_count = page_count | plus: 1 %}
              {% when 'article' %}
                {% assign article_count = article_count | plus: 1 %}
            {% endcase %}
          {% endfor %}
          
          {% if product_count > 0 %}
            <button class="search-filter-tab" data-filter="products">
              Products ({{ product_count }})
            </button>
          {% endif %}
          
          {% if collection_count > 0 %}
            <button class="search-filter-tab" data-filter="collections">
              Collections ({{ collection_count }})
            </button>
          {% endif %}
          
          {% if page_count > 0 %}
            <button class="search-filter-tab" data-filter="pages">
              Pages ({{ page_count }})
            </button>
          {% endif %}
          
          {% if article_count > 0 %}
            <button class="search-filter-tab" data-filter="articles">
              Articles ({{ article_count }})
            </button>
          {% endif %}
        </div>

        {% if product_count > 0 %}
          <!-- Product Sorting -->
          <div class="search-sort">
            <label for="search-sort-select" class="search-sort-label">Sort by:</label>
            <select id="search-sort-select" class="search-sort-select">
              <option value="relevance">Relevance</option>
              <option value="price-low-high">Price: Low to High</option>
              <option value="price-high-low">Price: High to Low</option>
              <option value="title-a-z">Title: A-Z</option>
              <option value="title-z-a">Title: Z-A</option>
              <option value="created-new-old">Newest First</option>
              <option value="created-old-new">Oldest First</option>
            </select>
          </div>
        {% endif %}
      </div>

      <!-- Search Results -->
      <div class="search-results">
        {% for item in search.results %}
          {% case item.object_type %}
            
            {% when 'product' %}
              <div class="search-result-item search-product" data-type="products">
                <div class="search-result-content">
                  <div class="search-result-image">
                    {% if item.featured_media %}
                      <a href="{{ item.url }}">
                        <img 
                          src="{{ item.featured_media | img_url: '300x300' }}" 
                          alt="{{ item.featured_media.alt | default: item.title }}"
                          loading="lazy"
                        >
                      </a>
                    {% else %}
                      <div class="search-result-placeholder">
                        <svg width="60" height="60" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <rect width="100" height="100" fill="#f0f0f0"/>
                          <path d="M25 25h50v50H25z" fill="#ddd"/>
                        </svg>
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="search-result-info">
                    <div class="search-result-type">Product</div>
                    <h3 class="search-result-title">
                      <a href="{{ item.url }}">{{ item.title }}</a>
                    </h3>
                    
                    {% if settings.product_show_vendor and item.vendor != blank %}
                      <div class="search-result-vendor">{{ item.vendor }}</div>
                    {% endif %}
                    
                    <div class="search-result-price">
                      {% if item.compare_at_price > item.price %}
                        <span class="search-price-on-sale">{{ item.price | money }}</span>
                        <span class="search-compare-price">{{ item.compare_at_price | money }}</span>
                      {% else %}
                        <span class="search-price">{{ item.price | money }}</span>
                      {% endif %}
                    </div>
                    
                    {% if item.description != blank %}
                      <div class="search-result-excerpt">
                        {{ item.description | strip_html | truncate: 120 }}
                      </div>
                    {% endif %}
                    
                    <div class="search-result-actions">
                      <a href="{{ item.url }}" class="search-view-btn">View Product</a>
                      {% if item.available %}
                        <button class="search-add-to-cart-btn" data-variant-id="{{ item.selected_or_first_available_variant.id }}">
                          Add to Cart - {{ item.price | money }}
                        </button>
                      {% else %}
                        <span class="search-sold-out">Sold Out</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            
            {% when 'collection' %}
              <div class="search-result-item search-collection" data-type="collections">
                <div class="search-result-content">
                  <div class="search-result-image">
                    {% if item.featured_image %}
                      <a href="{{ item.url }}">
                        <img 
                          src="{{ item.featured_image | img_url: '300x300' }}" 
                          alt="{{ item.featured_image.alt | default: item.title }}"
                          loading="lazy"
                        >
                      </a>
                    {% else %}
                      <div class="search-result-placeholder collection-placeholder">
                        <svg width="60" height="60" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <rect width="100" height="100" fill="#f0f0f0"/>
                          <rect x="20" y="20" width="25" height="25" fill="#ddd"/>
                          <rect x="55" y="20" width="25" height="25" fill="#ddd"/>
                          <rect x="20" y="55" width="25" height="25" fill="#ddd"/>
                          <rect x="55" y="55" width="25" height="25" fill="#ddd"/>
                        </svg>
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="search-result-info">
                    <div class="search-result-type">Collection</div>
                    <h3 class="search-result-title">
                      <a href="{{ item.url }}">{{ item.title }}</a>
                    </h3>
                    <div class="search-result-meta">{{ item.products_count }} products</div>
                    
                    {% if item.description != blank %}
                      <div class="search-result-excerpt">
                        {{ item.description | strip_html | truncate: 120 }}
                      </div>
                    {% endif %}
                    
                    <div class="search-result-actions">
                      <a href="{{ item.url }}" class="search-view-btn">View Collection</a>
                    </div>
                  </div>
                </div>
              </div>
            
            {% when 'page' %}
              <div class="search-result-item search-page" data-type="pages">
                <div class="search-result-content">
                  <div class="search-result-info full-width">
                    <div class="search-result-type">Page</div>
                    <h3 class="search-result-title">
                      <a href="{{ item.url }}">{{ item.title }}</a>
                    </h3>
                    
                    {% if item.content != blank %}
                      <div class="search-result-excerpt">
                        {{ item.content | strip_html | truncate: 150 }}
                      </div>
                    {% endif %}
                    
                    <div class="search-result-actions">
                      <a href="{{ item.url }}" class="search-view-btn">Read More</a>
                    </div>
                  </div>
                </div>
              </div>
            
            {% when 'article' %}
              <div class="search-result-item search-article" data-type="articles">
                <div class="search-result-content">
                  {% if item.image %}
                    <div class="search-result-image">
                      <a href="{{ item.url }}">
                        <img 
                          src="{{ item.image | img_url: '300x300' }}" 
                          alt="{{ item.image.alt | default: item.title }}"
                          loading="lazy"
                        >
                      </a>
                    </div>
                  {% endif %}
                  
                  <div class="search-result-info {% unless item.image %}full-width{% endunless %}">
                    <div class="search-result-type">Article</div>
                    <h3 class="search-result-title">
                      <a href="{{ item.url }}">{{ item.title }}</a>
                    </h3>
                    <div class="search-result-meta">
                      {{ item.published_at | date: "%B %d, %Y" }}
                      {% if item.author != blank %} â€¢ By {{ item.author }}{% endif %}
                    </div>
                    
                    {% if item.excerpt != blank %}
                      <div class="search-result-excerpt">
                        {{ item.excerpt | strip_html | truncate: 120 }}
                      </div>
                    {% elsif item.content != blank %}
                      <div class="search-result-excerpt">
                        {{ item.content | strip_html | truncate: 120 }}
                      </div>
                    {% endif %}
                    
                    <div class="search-result-actions">
                      <a href="{{ item.url }}" class="search-view-btn">Read Article</a>
                    </div>
                  </div>
                </div>
              </div>
              
          {% endcase %}
        {% endfor %}
      </div>

      <!-- Load More / Pagination -->
      {% if paginate.pages > 1 %}
        <div class="search-pagination">
          {{ paginate | default_pagination }}
        </div>
      {% endif %}

    {% else %}
      <!-- No Results Found -->
      <div class="search-no-results">
        <div class="no-results-icon">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="11" cy="11" r="8" stroke="#ccc" stroke-width="2"/>
            <path d="m21 21-4.35-4.35" stroke="#ccc" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 11h6M11 8v6" stroke="#ccc" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        
        <h2 class="no-results-title">No results found for "{{ search.terms }}"</h2>
        <p class="no-results-message">
          Try searching with different keywords or browse our collections below.
        </p>
        
        <!-- Search Suggestions -->
        <div class="search-suggestions">
          <h3>Search Suggestions:</h3>
          <ul class="suggestion-list">
            <li>Check your spelling</li>
            <li>Use more general keywords</li>
            <li>Try searching for product categories</li>
            <li>Browse our collections instead</li>
          </ul>
        </div>
        
        <!-- Popular Collections -->
        {% if collections.size > 0 %}
          <div class="popular-collections">
            <h3>Popular Collections</h3>
            <div class="collections-grid">
              {% for collection in collections limit: 4 %}
                {% unless collection.handle == 'all' %}
                  <a href="{{ collection.url }}" class="collection-card">
                    {% if collection.featured_image %}
                      <div class="collection-image">
                        <img src="{{ collection.featured_image | img_url: '200x200' }}" alt="{{ collection.title }}">
                      </div>
                    {% endif %}
                    <div class="collection-info">
                      <h4>{{ collection.title }}</h4>
                      <p>{{ collection.products_count }} products</p>
                    </div>
                  </a>
                {% endunless %}
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}
  {% else %}
    <!-- Initial Search Page (No search performed yet) -->
    <div class="search-welcome">
      <div class="search-welcome-content">
        <div class="search-welcome-icon">
          <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="11" cy="11" r="8" stroke="#666" stroke-width="2"/>
            <path d="m21 21-4.35-4.35" stroke="#666" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h2>What are you looking for?</h2>
        <p>Search through our products, collections, and pages to find exactly what you need.</p>
      </div>
    </div>
  {% endif %}
</div>

<script>
  // Search filter functionality
  document.addEventListener('DOMContentLoaded', function() {
    const filterTabs = document.querySelectorAll('.search-filter-tab');
    const searchItems = document.querySelectorAll('.search-result-item');
    const sortSelect = document.getElementById('search-sort-select');

    // Filter functionality
    filterTabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        
        // Update active tab
        filterTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Show/hide items
        searchItems.forEach(item => {
          if (filter === 'all' || item.getAttribute('data-type') === filter) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });
      });
    });

    // Sort functionality for products
    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        const sortValue = this.value;
        const productItems = Array.from(document.querySelectorAll('.search-product'));
        const resultsContainer = document.querySelector('.search-results');
        
        productItems.sort((a, b) => {
          switch(sortValue) {
            case 'price-low-high':
              return getPrice(a) - getPrice(b);
            case 'price-high-low':
              return getPrice(b) - getPrice(a);
            case 'title-a-z':
              return getTitle(a).localeCompare(getTitle(b));
            case 'title-z-a':
              return getTitle(b).localeCompare(getTitle(a));
            default:
              return 0; // Keep original order for relevance
          }
        });
        
        // Re-insert sorted items
        productItems.forEach(item => {
          resultsContainer.appendChild(item);
        });
      });
    }

    // Quick add to cart functionality
    document.querySelectorAll('.search-add-to-cart-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const variantId = this.getAttribute('data-variant-id');
        if (variantId) {
          // Add loading state
          this.textContent = 'Adding...';
          this.disabled = true;
          
          // Add to cart via AJAX
          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: variantId,
              quantity: 1
            })
          })
          .then(response => response.json())
          .then(data => {
            this.textContent = 'Added!';
            setTimeout(() => {
              this.textContent = 'Add to Cart';
              this.disabled = false;
            }, 2000);
          })
          .catch(error => {
            console.error('Error:', error);
            this.textContent = 'Error';
            setTimeout(() => {
              this.textContent = 'Add to Cart';
              this.disabled = false;
            }, 2000);
          });
        }
      });
    });

    // Helper functions
    function getPrice(item) {
      const priceElement = item.querySelector('.search-price, .search-price-on-sale');
      if (priceElement) {
        return parseFloat(priceElement.textContent.replace(/[^\d.]/g, ''));
      }
      return 0;
    }

    function getTitle(item) {
      const titleElement = item.querySelector('.search-result-title a');
      return titleElement ? titleElement.textContent.trim() : '';
    }
  });
</script>